#textdomain wesnoth-TDHR

#define NECRO_ADJACENT_CHECK X Y
    [have_unit]
        id="Gwiti Ha'atel"
        [filter_adjacent]
            x,y={X},{Y}
        [/filter_adjacent]
    [/have_unit]
#enddef

#define NECRO_CONSTANTS
    {VARIABLE gwiti_max_gold 100}
    {VARIABLE gold_cost_level_0 10}
    {VARIABLE gold_cost_level_1 20}
    {VARIABLE gold_cost_level_2 30}
    {VARIABLE gold_cost_level_3 40}
    {VARIABLE gold_return_base_level_0 10}
    {VARIABLE gold_return_base_level_1 20}
    {VARIABLE gold_return_base_level_2 30}
    {VARIABLE gold_return_base_level_3 40}
    {VARIABLE max_called_units 20}
#enddef

#define NECROMANCY_INFO_MENU
    [set_menu_item]
        id=necromancy_info
        description= _ "Necromancy Info"
        [show_if]
            [have_unit]
                id="Gwiti Ha'atel"
                x,y=$x1,$y1
            [/have_unit]
        [/show_if]
        [command]
            [message]
                speaker="Gwiti Ha'atel"
                caption= _ "Necromancy Status Help"
                message= _ "<span color='#00FF00'>Called Units:</span> $current_called_units/$max_called_units

Costs for calling undead:
<span color='#00FFFF'>Level 0:</span> $gold_cost_level_0 gold
<span color='#00FFFF'>Level 1:</span> $gold_cost_level_1 gold
<span color='#00FFFF'>Level 2:</span> $gold_cost_level_2 gold
<span color='#00FFFF'>Level 3:</span> $gold_cost_level_3 gold"
            [/message]
        [/command]
    [/set_menu_item]
#enddef

# Right-click menu option to sacrifice undead units for gold.
#define NECROMANCY_SACRIFICE_MENU
    [set_menu_item]
        id=necromancy_sacrifice
        description= _ "Sacrifice Undead"
        [show_if]
            # Only show for undead units that were called by necromancy.
            [have_unit]
                side=1
                [filter_wml]
                    [variables]
                        called=yes
                    [/variables]
                [/filter_wml]
                x,y=$x1,$y1
            [/have_unit]
            [and]
                {NECRO_ADJACENT_CHECK $x1 $y1}
            [/and]
        [/show_if]
        [command]
            # Store and remove the unit being sacrificed.
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                variable=sacrifice_unit
                kill=no
            [/store_unit]
            [kill]
                x,y=$x1,$y1
                fire_event=no
                animate=no
            [/kill]
            [redraw]
                clear_shroud=yes
            [/redraw]

            # Calculate gold return based on unit level.
            [switch]
                variable=sacrifice_unit.level
                [case]
                    value=0
                    {VARIABLE base_return $gold_return_base_level_0}
                [/case]
                [case]
                    value=1
                    {VARIABLE base_return $gold_return_base_level_1}
                [/case]
                [case]
                    value=2
                    {VARIABLE base_return $gold_return_base_level_2}
                [/case]
                [case]
                    value=3
                    {VARIABLE base_return $gold_return_base_level_3}
                [/case]
                [else]
                    {VARIABLE base_return 50}
                [/else]
            [/switch]

            # Adjust gold return based on unit's remaining health.
            [set_variable]
                name=gold_return
                multiply=$base_return
                divide=$sacrifice_unit.max_hitpoints
                value=$sacrifice_unit.hitpoints
                round=floor
            [/set_variable]

            [store_gold]
                side=1
                variable=gwiti_gold
            [/store_gold]

            {VARIABLE_OP gwiti_gold add $gold_return}
            [if]
                [variable]
                    name=gwiti_gold
                    greater_than=$gwiti_max_gold
                [/variable]
                [then]
                    {VARIABLE gwiti_gold $gwiti_max_gold}
                [/then]
            [/if]

            [modify_side]
                side=1
                gold=$gwiti_gold
            [/modify_side]

            # Reduce the count of called units.
            {VARIABLE_OP current_called_units sub 1}
            [if]
                [variable]
                    name=current_called_units
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE current_called_units 0}
                [/then]
            [/if]

            [redraw]
                side=1
            [/redraw]

            [sound]
                name=gold.ogg
            [/sound]

            # Show sacrifice effects.
            [floating_text]
                x,y=$x1,$y1
                text= _ "<span color='#FF00FF' size='x-small'>Sacrificed:</span> <span color='#FFFFFF' size='x-small'>+$gold_return gold</span>"
            [/floating_text]

            # Clean up variables.
            {CLEAR_VARIABLE sacrifice_unit,base_return,gold_return,gwiti_gold}
        [/command]
    [/set_menu_item]
#enddef

# Right-click menu option to empower undead units.
#define NECROMANCY_EMPOWER_MENU
    [set_menu_item]
        id=necromancy_boost
        description= _ "Empower Undead"
        [show_if]
            # Only show for undead units that were called by necromancy.
            [have_unit]
                side=1
                [filter_wml]
                    [variables]
                        called=yes
                    [/variables]
                [/filter_wml]
                x,y=$x1,$y1
            [/have_unit]
            [and]
                {NECRO_ADJACENT_CHECK $x1 $y1}
            [/and]
        [/show_if]
        [command]
            [store_gold]
                side=1
                variable=gwiti_gold
            [/store_gold]

            [if]
                [variable]
                    name=gwiti_gold
                    greater_than_equal_to=10
                [/variable]
                [then]
                    # Store the unit being empowered.
                    [store_unit]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                        variable=boost_unit
                        kill=no
                    [/store_unit]

                    # Display empowerment options.
                    [message]
                        speaker="Gwiti Ha'atel"
                        message= _ "How shall I empower this servant?"

                        # Option 1: Restore actions (movement and attacks).
                        [option]
                            description= _ "With 10 gold, give the servant another damned action."
                            image=icons/sandals.png
                            [show_if]
                                [variable]
                                    name=boost_unit.moves
                                    numerical_equals=0
                                [/variable]
                                [variable]
                                    name=gwiti_gold
                                    greater_than_equal_to=10
                                [/variable]
                            [/show_if]
                            [command]
                                [animate_unit]
                                    [filter]
                                        id="Gwiti Ha'atel"
                                    [/filter]
                                    flag=recruit
                                    [facing]
                                        x,y=$x1,$y1
                                    [/facing]
                                [/animate_unit]

                                [gold]
                                    side=1
                                    amount=-10
                                [/gold]

                                {VARIABLE boost_unit.moves $boost_unit.max_moves}
                                {VARIABLE boost_unit.attacks_left $boost_unit.max_attacks}

                                [unstore_unit]
                                    variable=boost_unit
                                    find_vacant=no
                                [/unstore_unit]
                                [redraw]
                                    clear_shroud=yes
                                [/redraw]

                                [floating_text]
                                    x,y=$x1,$y1
                                    text= _ "<span color='#FF00FF' size='x-small'>Actions restored!</span>"
                                [/floating_text]
                            [/command]
                        [/option]

                        # Option 2: Restore vitality (health).
                        [option]
                            description= _ "I shall restore the vitality of this dead with 10 gold."
                            image=icons/potion_red_medium.png
                            [show_if]
                                [variable]
                                    name=boost_unit.hitpoints
                                    numerical_not_equals=boost_unit.max_hitpoints
                                [/variable]
                                [variable]
                                    name=gwiti_gold
                                    greater_than_equal_to=10
                                [/variable]
                            [/show_if]
                            [command]
                                [animate_unit]
                                    [filter]
                                        id="Gwiti Ha'atel"
                                    [/filter]
                                    flag=recruit
                                    [facing]
                                        x,y=$x1,$y1
                                    [/facing]
                                [/animate_unit]

                                [gold]
                                    side=1
                                    amount=-10
                                [/gold]

                                [heal_unit]
                                    [filter]
                                        id=$boost_unit.id
                                    [/filter]
                                    amount=full
                                    animate=no
                                [/heal_unit]

                                [floating_text]
                                    x,y=$x1,$y1
                                    text= _ "<span color='#FF00FF' size='x-small'>Vitality restored!</span>"
                                [/floating_text]
                            [/command]
                        [/option]

                        # Option 3: Boost damage.
                        [option]
                            description= _ "Let these weapons be infused with my magic and 20 gold."
                            image=icons/crossed_sword_and_hammer.png
                            [show_if]
                                [variable]
                                    name=gwiti_gold
                                    greater_than_equal_to=20
                                [/variable]
                            [/show_if]
                            [command]
                                [animate_unit]
                                    [filter]
                                        id="Gwiti Ha'atel"
                                    [/filter]
                                    flag=recruit
                                    [facing]
                                        x,y=$x1,$y1
                                    [/facing]
                                [/animate_unit]

                                [gold]
                                    side=1
                                    amount=-20
                                [/gold]

                                # Apply temporary damage boost.
                                [object]
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                    duration=turn
                                    [effect]
                                        apply_to=attack
                                        increase_damage=2
                                    [/effect]
                                [/object]

                                [floating_text]
                                    x,y=$x1,$y1
                                    text= _ "<span color='#FF00FF' size='x-small'>Damage boosted!</span>"
                                [/floating_text]
                            [/command]
                        [/option]

                        # Option to cancel.
                        [option]
                            description= _ "It is wise to do nothing now."
                            image=icons/key_silver.png
                            [command]
                                [allow_undo][/allow_undo]
                            [/command]
                        [/option]
                    [/message]

                    {CLEAR_VARIABLE boost_unit}
                [/then]
                [else]
                    [message]
                        speaker="Gwiti Ha'atel"
                        message= _ "I am not having enough gold."
                    [/message]
                [/else]
            [/if]

            {CLEAR_VARIABLE gwiti_gold}
        [/command]
    [/set_menu_item]
#enddef

# Initialize the necromancy system by setting constants, initializing tracking variables, and registering right-click menu options.
#define NECROMANCY_INIT
    {NECRO_CONSTANTS}

    [modify_side]
        side=1
        gold=20
        income=3
    [/modify_side]

    {VARIABLE necromancy_used 0}
    {VARIABLE current_called_units 0}
    {VARIABLE total_necro_actions 0}
    {VARIABLE necro_tier 0}

    {NECROMANCY_INFO_MENU}
    {NECROMANCY_SACRIFICE_MENU}
    {NECROMANCY_EMPOWER_MENU}
#enddef

# Main mechanics for the necromancy system.
#define NECROMANCY_MECHANICS
    [event]
        name=prestart
        {NECROMANCY_INIT}
    [/event]

    [event]
        name=side 1 turn
        first_time_only=no

        [store_gold]
            side=1
            variable=gwiti_gold
        [/store_gold]

        [if]
            [variable]
                name=gwiti_gold
                greater_than=$gwiti_max_gold
            [/variable]
            [then]
                {VARIABLE gwiti_gold $gwiti_max_gold}
            [/then]
        [/if]

        [modify_side]
            side=1
            gold=$gwiti_gold
        [/modify_side]
        {CLEAR_VARIABLE gwiti_gold}

        # Check for necromancy tier upgrade based on total actions.
        [if]
            [variable]
                name=total_necro_actions
                greater_than_equal_to=$((10 * ($necro_tier + 1)))
            [/variable]
            [and]
                [variable]
                    name=total_necro_actions
                    less_than=$((10 * ($necro_tier + 2)))
                [/variable]
            [/and]
            [then]
                # Increase max gold and necromancy tier.
                {VARIABLE_OP gwiti_max_gold add 10}
                {VARIABLE_OP necro_tier add 1}
                [message]
                    speaker="Gwiti Ha'atel"
                    message= _ "My necromantic power grows! Max gold increased."
                [/message]
            [/then]
        [/if]
    [/event]

    # Update called units count when a called unit dies.
    [event]
        name=die
        first_time_only=no
        [filter]
            [filter_wml]
                [variables]
                    called=yes
                [/variables]
            [/filter_wml]
        [/filter]

        # Reduce count of called units.
        {VARIABLE_OP current_called_units sub 1}
        [if]
            [variable]
                name=current_called_units
                less_than=0
            [/variable]
            [then]
                {VARIABLE current_called_units 0}
            [/then]
        [/if]
    [/event]

    # Handle necromancy when the unit kills an enemy unit.
    [event]
        name=die
        first_time_only=no
        [filter]
            # Filters to living units that can be raised.
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
            [not]
                [filter_wml]
                    undead_variation=null
                [/filter_wml]
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter]
        [filter_second_attack]
            range=ranged
            special_id=magical
        [/filter_second_attack]

        # Store and remove the dead unit.
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=dead_unit
            kill=yes
        [/store_unit]

        # Check if Gwiti is adjacent for bonus chance.
        [if]
            {NECRO_ADJACENT_CHECK $dead_unit.x $dead_unit.y}
            [then]
                {VARIABLE necro_bonus 10}
            [/then]
            [else]
                {VARIABLE necro_bonus 0}
            [/else]
        [/if]

        # Base necromancy chance based on unit level.
        [if]
            [variable]
                name=dead_unit.level
                equals=0
            [/variable]
            [then]
                {VARIABLE necro_chance 80}
            [/then]
            [elseif]
                [variable]
                    name=dead_unit.level
                    equals=1
                [/variable]
                [then]
                    {VARIABLE necro_chance 60}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=dead_unit.level
                    equals=2
                [/variable]
                [then]
                    {VARIABLE necro_chance 40}
                [/then]
            [/elseif]
            [else]
                {VARIABLE necro_chance 20}
            [/else]
        [/if]

        {VARIABLE_OP necro_chance add $necro_bonus}
        [if]
            [variable]
                name=necro_chance
                less_than=10
            [/variable]
            [then]
                {VARIABLE necro_chance 10}
            [/then]
        [/if]
        [if]
            [variable]
                name=necro_chance
                greater_than=90
            [/variable]
            [then]
                {VARIABLE necro_chance 90}
            [/then]
        [/if]

        # Determine undead type based on race and level.
        [switch]
            variable=dead_unit.race
            [case]
                value=bats,goblin,wolf
                {VARIABLE target_type "Walking Corpse"}
            [/case]
            [case]
                value=drake,gryphon,merman,naga,lizard
                {VARIABLE target_type "Soulless"}
            [/case]
            [case]
                value=monster,wose
                {VARIABLE target_type "Ghost"}
            [/case]
            [case]
                value=ogre
                {VARIABLE target_type "Ghoul"}
            [/case]
            [else]
                [if]
                    [variable]
                        name=dead_unit.level
                        greater_than_equal_to=2
                    [/variable]
                    [then]
                        [switch]
                            variable=dead_unit.usage
                            [case]
                                value=fighter
                                {VARIABLE target_type "Revenant"}
                            [/case]
                            [case]
                                value=archer
                                {VARIABLE target_type "Bone Shooter"}
                            [/case]
                            [case]
                                value=mixed fighter
                                {VARIABLE target_type "Wraith"}
                            [/case]
                            [case]
                                value=scout
                                {VARIABLE target_type "Bone Knight"}
                            [/case]
                        [/switch]
                    [/then]
                    [elseif]
                        [variable]
                            name=dead_unit.level
                            equals=1
                        [/variable]
                        [then]
                            [switch]
                                variable=dead_unit.usage
                                [case]
                                    value=fighter
                                    {VARIABLE target_type "Skeleton"}
                                [/case]
                                [case]
                                    value=archer
                                    {VARIABLE target_type "Skeleton Archer"}
                                [/case]
                                [case]
                                    value=mixed fighter
                                    {VARIABLE target_type "Ghost"}
                                [/case]
                                [case]
                                    value=scout
                                    {VARIABLE target_type "Skeleton Rider"}
                                [/case]
                            [/switch]
                        [/then]
                    [/elseif]
                    [else]
                        {VARIABLE target_type "Walking Corpse"}
                    [/else]
                [/if]
            [/else]
        [/switch]

        # Get unit type information to determine cost.
        [store_unit_type]
            type=$target_type
            variable=target_unit_type
        [/store_unit_type]

        # Set cost based on unit level.
        [switch]
            variable=target_unit_type.level
            [case]
                value=0
                {VARIABLE gold_cost $gold_cost_level_0}
            [/case]
            [case]
                value=1
                {VARIABLE gold_cost $gold_cost_level_1}
            [/case]
            [case]
                value=2
                {VARIABLE gold_cost $gold_cost_level_2}
            [/case]
            [case]
                value=3
                {VARIABLE gold_cost $gold_cost_level_3}
            [/case]
            [else]
                {VARIABLE gold_cost 50}
            [/else]
        [/switch]

        [store_gold]
            side=1
            variable=gwiti_gold
        [/store_gold]

        # Roll for necromancy success.
        {RANDOM 1..100}
        [if]
            [variable]
                name=random
                less_than_equal_to=$necro_chance
            [/variable]
            [and]
                [variable]
                    name=gwiti_gold
                    greater_than_equal_to=$gold_cost
                [/variable]
            [/and]
            [and]
                [variable]
                    name=current_called_units
                    less_than=$max_called_units
                [/variable]
            [/and]
            [then]
                # Successful necromancy animation.
                [animate_unit]
                    [filter]
                        id="Gwiti Ha'atel"
                    [/filter]
                    flag=recruit
                    [facing]
                        x,y=$dead_unit.x,$dead_unit.y
                    [/facing]
                [/animate_unit]

                # Create the new undead unit.
                [unit]
                    type=$target_type
                    side=1
                    x,y=$dead_unit.x,$dead_unit.y
                    facing=$dead_unit.facing
                    gender=$dead_unit.gender
                    variation=$dead_unit.undead_variation
                    animate=yes
                    attacks_left=0
                    moves=0
                    resting=no
                    upkeep=loyal
                    [variables]
                        called=yes
                    [/variables]
                [/unit]
                [redraw]
                    clear_shroud=yes
                [/redraw]

                {VARIABLE_OP gwiti_gold sub $gold_cost}
                [modify_side]
                    side=1
                    gold=$gwiti_gold
                [/modify_side]

                {VARIABLE_OP current_called_units add 1}
                {VARIABLE_OP total_necro_actions add 1}

                # Show success message.
                [floating_text]
                    x,y=$dead_unit.x,$dead_unit.y
                    text="<span color='#00FF00' size='x-small'>$target_type</span>"
                [/floating_text]
            [/then]
            [else]
                # Failed necromancy.
                [if]
                    [variable]
                        name=gwiti_gold
                        less_than=$gold_cost
                    [/variable]
                    [then]
                        # Not enough gold.
                        [floating_text]
                            x,y=$dead_unit.x,$dead_unit.y
                            text= _ "<span color='#FF0000' size='x-small'>Need $gold_cost gold to call $target_type!</span>"
                        [/floating_text]
                    [/then]
                    [elseif]
                        [variable]
                            name=current_called_units
                            greater_than_equal_to=$max_called_units
                        [/variable]
                        [then]
                            # Too many units already called.
                            [floating_text]
                                x,y=$dead_unit.x,$dead_unit.y
                                text= _ "<span color='#FF0000' size='x-small'>Cannot call more units!</span>"
                            [/floating_text]
                        [/then]
                    [/elseif]
                    [else]
                        # Failed roll check.
                        [floating_text]
                            x,y=$dead_unit.x,$dead_unit.y
                            text= _ "<span color='#FF0000' size='x-small'>The soul resists the call!</span>"
                        [/floating_text]
                    [/else]
                [/if]
            [/else]
        [/if]

        # Clean up variables.
        {CLEAR_VARIABLE dead_unit,necro_chance,random,target_type,gold_cost,gwiti_gold,necro_bonus,target_unit_type}
    [/event]

    # Clean up all variables at scenario end.
    [event]
        name=victory
        {CLEAR_VARIABLE necromancy_used,gwiti_max_gold,current_called_units,max_called_units,total_necro_actions,necro_tier}
    [/event]
#enddef
