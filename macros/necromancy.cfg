#textdomain wesnoth-TDHR

# Define the floating text display that shows Gwiti's mana and called units status.
# This appears above the unit when selected.
#define DISPLAY_STATUS
    [floating_text]
        [filter]
            id="Gwiti Ha'atel"
        [/filter]
        text= _ "<span color='#00FFFF' size='x-small'>Mana:</span> <span color='#FFFFFF' size='x-small'>$gwiti_mana/$gwiti_max_mana |</span> <span color='#00FF00' size='x-small'>Called:</span> <span color='#FFFFFF' size='x-small'>$current_called_units/$max_called_units</span>"
    [/floating_text]
#enddef

# Helper macro to check if Gwiti is adjacent to the specified coordinates.
# Used in several menu options for actions that require Gwiti to be nearby.
#define GWITI_ADJACENT_CHECK X Y
    [have_unit]
        id="Gwiti Ha'atel"
        [filter_adjacent]
            x,y={X},{Y}
        [/filter_adjacent]
    [/have_unit]
#enddef

# Constants for the necromancy system.
# Defines mana limits, regeneration rates, costs for different unit levels,
# and mana returned when sacrificing units.
#define NECRO_CONSTANTS
    # Maximum mana capacity.
    {VARIABLE gwiti_max_mana 50}

    # Amount of mana regenerated each turn.
    {VARIABLE gwiti_mana_regen 5}

    # Mana costs for summoning different level units.
    {VARIABLE mana_cost_level_0 5}
    {VARIABLE mana_cost_level_1 10}
    {VARIABLE mana_cost_level_2 20}
    {VARIABLE mana_cost_level_3 30}

    # Base mana returned when sacrificing units of different levels.
    {VARIABLE mana_return_base_level_0 5}
    {VARIABLE mana_return_base_level_1 8}
    {VARIABLE mana_return_base_level_2 15}
    {VARIABLE mana_return_base_level_3 25}

    # Maximum number of undead units that can be controlled at once.
    {VARIABLE max_called_units 20}
#enddef

# Right-click menu option to display current necromancy information.
# Shows mana status, regeneration rate, and unit costs.
#define NECROMANCY_INFO_MENU
    [set_menu_item]
        id=necromancy_info
        description= _ "Necromancy Info"
        [show_if]
            [have_unit]
                id="Gwiti Ha'atel"
                x,y=$x1,$y1
            [/have_unit]
        [/show_if]
        [command]
            [message]
                speaker="Gwiti Ha'atel"
                caption= _ "Necromancy Status"
                message= _ "<span color='#00FFFF'>Mana:</span> $gwiti_mana/$gwiti_max_mana
<span color='#00FFFF'>Mana Regeneration:</span> $gwiti_mana_regen per turn
<span color='#00FF00'>Called Units:</span> $current_called_units/$max_called_units

Mana costs for calling undead:
<span color='#00FFFF'>Level 0:</span> $mana_cost_level_0 mana
<span color='#00FFFF'>Level 1:</span> $mana_cost_level_1 mana
<span color='#00FFFF'>Level 2:</span> $mana_cost_level_2 mana
<span color='#00FFFF'>Level 3:</span> $mana_cost_level_3 mana"
            [/message]
        [/command]
    [/set_menu_item]
#enddef

# Right-click menu option to display advanced help for necromancy.
#define NECROMANCY_HELP_MENU
    [set_menu_item]
        id=necromancy_help
        description= _ "Necromancy Help"
        [show_if]
            [have_unit]
                id="Gwiti Ha'atel"
                x,y=$x1,$y1
            [/have_unit]
        [/show_if]
        [command]
            [message]
                speaker="Gwiti Ha'atel"
                caption= _ "Necromancy System Help"
                message= _ "<span color='#00FFFF'>Mana</span>
You begin with <b>15 mana</b> and regenerate <b>5 mana</b> each turn. Your maximum mana is <b>50</b>, but it can increase as you perform more necromantic actions.

<span color='#00FFFF'>Calling Undead</span>
When an enemy unit is defeated by a ranged magical attack from your side, there’s a chance to raise it as an undead servant. The success rate increases by 10% if Gwiti is adjacent to the defeated unit. This costs mana based on the undead’s level.

<span color='#00FFFF'>Sacrificing Undead</span>
You can sacrifice your summoned undead units to recover some mana. The amount regained depends on the unit’s level and remaining health.

<span color='#00FFFF'>Empowering Undead</span>
Spend mana to heal, restore actions, or increase the damage of your summoned undead units.

<span color='#00FFFF'>Limits</span>
You can control a maximum of <b>20 undead units</b> at once. Exceeding this limit prevents further summoning.

<span color='#00FFFF'>Progression</span>
For every <b>10 necromantic actions</b>, your necromantic power grows, increasing your maximum mana capacity.

<span color='#FF00FF'>Tip</span>: Necromancy is a delicate balance. Manage your mana carefully and monitor your undead count to maintain control!"
            [/message]
        [/command]
    [/set_menu_item]
#enddef

# Right-click menu option to sacrifice undead units for mana.
# Only available on Gwiti's summoned undead units when Gwiti is adjacent to them.
#define NECROMANCY_SACRIFICE_MENU
    [set_menu_item]
        id=necromancy_sacrifice
        description= _ "Sacrifice Undead"
        [show_if]
            # Only show for undead units that were called by necromancy.
            [have_unit]
                side=1
                [filter_wml]
                    [variables]
                        called=yes
                    [/variables]
                [/filter_wml]
                x,y=$x1,$y1
            [/have_unit]
            [and]
                # Gwiti must be adjacent to the unit.
                {GWITI_ADJACENT_CHECK $x1 $y1}
            [/and]
        [/show_if]
        [command]
            # Store and remove the unit being sacrificed.
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                variable=sacrifice_unit
                kill=yes
            [/store_unit]
            [redraw]
                clear_shroud=yes
            [/redraw]

            # Calculate mana return based on unit level.
            [switch]
                variable=sacrifice_unit.level
                [case]
                    value=0
                    {VARIABLE base_return $mana_return_base_level_0}
                [/case]
                [case]
                    value=1
                    {VARIABLE base_return $mana_return_base_level_1}
                [/case]
                [case]
                    value=2
                    {VARIABLE base_return $mana_return_base_level_2}
                [/case]
                [case]
                    value=3
                    {VARIABLE base_return $mana_return_base_level_3}
                [/case]
                [else]
                    {VARIABLE base_return 35}
                [/else]
            [/switch]

            # Adjust mana return based on unit's remaining health.
            [set_variable]
                name=mana_return
                multiply=$base_return
                divide=$sacrifice_unit.max_hitpoints
                value=$sacrifice_unit.hitpoints
                round=floor
            [/set_variable]

            # Add mana to Gwiti's pool and cap at maximum.
            {VARIABLE_OP gwiti_mana add $mana_return}
            [if]
                [variable]
                    name=gwiti_mana
                    greater_than=$gwiti_max_mana
                [/variable]
                [then]
                    {VARIABLE gwiti_mana $gwiti_max_mana}
                [/then]
            [/if]

            # Reduce the count of called units.
            {VARIABLE_OP current_called_units sub 1}
            [if]
                [variable]
                    name=current_called_units
                    less_than=0
                [/variable]
                [then]
                    {VARIABLE current_called_units 0}
                [/then]
            [/if]

            # Show sacrifice effects.
            {DISPLAY_STATUS}
            [floating_text]
                x,y=$x1,$y1
                text= _ "<span color='#FF00FF' size='x-small'>Sacrificed:</span> <span color='#FFFFFF' size='x-small'>+$mana_return mana</span>"
            [/floating_text]
            [animate_unit]
                [filter]
                    id="Gwiti Ha'atel"
                [/filter]
                flag=recruit
                [facing]
                    x,y=$x1,$y1
                [/facing]
            [/animate_unit]

            # Clean up variables.
            {CLEAR_VARIABLE sacrifice_unit,base_return,mana_return}
        [/command]
    [/set_menu_item]
#enddef

# Right-click menu option to empower undead units.
# Provides options for healing, restoring actions, or boosting damage.
#define NECROMANCY_EMPOWER_MENU
    [set_menu_item]
        id=necromancy_boost
        description= _ "Empower Undead"
        [show_if]
            # Only show for undead units that were called by necromancy.
            [have_unit]
                side=1
                [filter_wml]
                    [variables]
                        called=yes
                    [/variables]
                [/filter_wml]
                x,y=$x1,$y1
            [/have_unit]
            [and]
                # Gwiti must be adjacent to the unit.
                {GWITI_ADJACENT_CHECK $x1 $y1}
            [/and]
            [and]
                # Must have at least 5 mana to empower.
                [variable]
                    name=gwiti_mana
                    greater_than_equal_to=5
                [/variable]
            [/and]
        [/show_if]
        [command]
            # Store the unit being empowered.
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                variable=boost_unit
            [/store_unit]

            # Display empowerment options.
            [message]
                speaker="Gwiti Ha'atel"
                message= _ "How shall I empower this servant?"

                # Option 1: Restore vitality (health).
                [option]
                    description= _ "<span color='#00FFFF'>Restore vitality:</span> 5 mana"
                    image=icons/potion_red_medium.png
                    [show_if]
                        [variable]
                            name=gwiti_mana
                            greater_than_equal_to=5
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE_OP gwiti_mana sub 5}
                        {VARIABLE_OP boost_unit.hitpoints add 10}

                        # Cap health at max.
                        [if]
                            [variable]
                                name=boost_unit.hitpoints
                                greater_than=$boost_unit.max_hitpoints
                            [/variable]
                            [then]
                                {VARIABLE boost_unit.hitpoints $boost_unit.max_hitpoints}
                            [/then]
                        [/if]

                        # Update the unit.
                        [unstore_unit]
                            variable=boost_unit
                            find_vacant=no
                            animate=yes
                        [/unstore_unit]

                        # Show empowerment effects.
                        {DISPLAY_STATUS}
                        [floating_text]
                            x,y=$x1,$y1
                            text= _ "<span color='#FF00FF' size='x-small'>Vitality restored!</span>"
                        [/floating_text]
                        [animate_unit]
                            [filter]
                                id="Gwiti Ha'atel"
                            [/filter]
                            flag=defend
                            [facing]
                                x,y=$x1,$y1
                            [/facing]
                        [/animate_unit]
                    [/command]
                [/option]

                # Option 2: Restore actions (movement and attacks).
                [option]
                    description= _ "<span color='#00FFFF'>Restore actions:</span> 5 mana"
                    image=icons/sandals.png
                    [show_if]
                        [variable]
                            name=gwiti_mana
                            greater_than_equal_to=5
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE_OP gwiti_mana sub 5}
                        {VARIABLE boost_unit.moves $boost_unit.max_moves}
                        {VARIABLE boost_unit.attacks_left $boost_unit.max_attacks}

                        # Update the unit.
                        [unstore_unit]
                            variable=boost_unit
                            find_vacant=no
                            animate=yes
                        [/unstore_unit]
                        [redraw]
                            clear_shroud=yes
                        [/redraw]

                        # Show empowerment effects.
                        {DISPLAY_STATUS}
                        [floating_text]
                            x,y=$x1,$y1
                            text= _ "<span color='#FF00FF' size='x-small'>Actions restored!</span>"
                        [/floating_text]
                        [animate_unit]
                            [filter]
                                id="Gwiti Ha'atel"
                            [/filter]
                            flag=defend
                            [facing]
                                x,y=$x1,$y1
                            [/facing]
                        [/animate_unit]
                    [/command]
                [/option]

                # Option 3: Boost damage.
                [option]
                    description= _ "<span color='#00FFFF'>Boost damage:</span> 10 mana"
                    image=icons/crossed_sword_and_hammer.png
                    [show_if]
                        [variable]
                            name=gwiti_mana
                            greater_than_equal_to=10
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE_OP gwiti_mana sub 10}

                        # Apply temporary damage boost.
                        [object]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            duration=turn
                            [effect]
                                apply_to=attack
                                increase_damage=2
                            [/effect]
                        [/object]

                        # Show empowerment effects.
                        {DISPLAY_STATUS}
                        [floating_text]
                            x,y=$x1,$y1
                            text= _ "<span color='#FF00FF' size='x-small'>Damage boosted!</span>"
                        [/floating_text]
                        [animate_unit]
                            [filter]
                                id="Gwiti Ha'atel"
                            [/filter]
                            flag=defend
                            [facing]
                                x,y=$x1,$y1
                            [/facing]
                        [/animate_unit]
                    [/command]
                [/option]

                # Option to cancel.
                [option]
                    description= _ "Cancel"
                    image=icons/key_silver.png
                    [show_if]
                        [variable]
                            name=gwiti_mana
                            greater_than_equal_to=5
                        [/variable]
                    [/show_if]
                    [command]
                        [allow_undo][/allow_undo]
                    [/command]
                [/option]
            [/message]

            # Clean up variables.
            {CLEAR_VARIABLE boost_unit}
        [/command]
    [/set_menu_item]
#enddef

# Initialize the necromancy system by setting constants, initializing tracking variables, and registering right-click menu options.
#define NECROMANCY_INIT
    # Set up the constants.
    {NECRO_CONSTANTS}

    # Initialize tracking variables.
    {VARIABLE necromancy_used 0}
    {VARIABLE gwiti_mana 15}              # Starting mana.
    {VARIABLE current_called_units 0}     # Starting with no called units.
    {VARIABLE total_necro_actions 0}      # Counter for progression.
    {VARIABLE necro_tier 0}               # Starting tier for necromantic power.

    # Register the right-click menu options.
    {NECROMANCY_INFO_MENU}
    {NECROMANCY_HELP_MENU}
    {NECROMANCY_SACRIFICE_MENU}
    {NECROMANCY_EMPOWER_MENU}
#enddef

# Main mechanics for the necromancy system.
# Includes event handlers for prestart, side 1 turn, die (for both called units and enemy units), select, and victory.
#define NECROMANCY_MECHANICS
    # Initialize at start of scenario.
    [event]
        name=prestart
        {NECROMANCY_INIT}
    [/event]

    # Regenerate mana at start of Gwiti's turn and check for tier upgrades.
    [event]
        name=side 1 turn
        first_time_only=no

        # Regenerate mana and cap at maximum.
        {VARIABLE_OP gwiti_mana add $gwiti_mana_regen}
        [if]
            [variable]
                name=gwiti_mana
                greater_than=$gwiti_max_mana
            [/variable]
            [then]
                {VARIABLE gwiti_mana $gwiti_max_mana}
            [/then]
        [/if]
        {DISPLAY_STATUS}

        # Check for necromancy tier upgrade based on total actions.
        [if]
            [variable]
                name=total_necro_actions
                greater_than_equal_to=$((10 * ($necro_tier + 1)))
            [/variable]
            [and]
                [variable]
                    name=total_necro_actions
                    less_than=$((10 * ($necro_tier + 2)))
                [/variable]
            [/and]
            [then]
                # Increase max mana and necromancy tier.
                {VARIABLE_OP gwiti_max_mana add 5}
                {VARIABLE_OP necro_tier add 1}
                [message]
                    speaker="Gwiti Ha'atel"
                    message= _ "My necromantic power grows! Max mana increased."
                [/message]
            [/then]
        [/if]
    [/event]

    # Update called units count when a called unit dies.
    [event]
        name=die
        first_time_only=no
        [filter]
            [filter_wml]
                [variables]
                    called=yes
                [/variables]
            [/filter_wml]
        [/filter]

        # Reduce count of called units.
        {VARIABLE_OP current_called_units sub 1}
        [if]
            [variable]
                name=current_called_units
                less_than=0
            [/variable]
            [then]
                {VARIABLE current_called_units 0}
            [/then]
        [/if]
    [/event]

    # Handle necromancy when the unit kills an enemy unit.
    [event]
        name=die
        first_time_only=no
        [filter]
            # Filters to living units that can be raised.
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
            [not]
                [filter_wml]
                    undead_variation=null
                [/filter_wml]
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter]
        [filter_second_attack]
            range=ranged
            special_id=magical
        [/filter_second_attack]

        # Store and remove the dead unit.
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=dead_unit
            kill=yes
        [/store_unit]

        # Check if Gwiti is adjacent for bonus chance.
        [if]
            [have_unit]
                id="Gwiti Ha'atel"
                [filter_adjacent]
                    x,y=$dead_unit.x,$dead_unit.y
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE necro_bonus 10}
            [/then]
            [else]
                {VARIABLE necro_bonus 0}
            [/else]
        [/if]

        # Base necromancy chance based on unit level.
        [if]
            [variable]
                name=dead_unit.level
                equals=0
            [/variable]
            [then]
                {VARIABLE necro_chance 70}
            [/then]
            [elseif]
                [variable]
                    name=dead_unit.level
                    equals=1
                [/variable]
                [then]
                    {VARIABLE necro_chance 50}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=dead_unit.level
                    equals=2
                [/variable]
                [then]
                    {VARIABLE necro_chance 30}
                [/then]
            [/elseif]
            [else]
                {VARIABLE necro_chance 10}
            [/else]
        [/if]

        # Adjust chance based on race.
        [switch]
            variable=dead_unit.race
            [case]
                value=elf,dwarf
                {VARIABLE_OP necro_chance sub 10}  # Elves and dwarves resist.
            [/case]
            [case]
                value=troll
                {VARIABLE_OP necro_chance sub 20}  # Trolls resist more.
            [/case]
            [case]
                value=wose
                {VARIABLE_OP necro_chance sub 30}  # Woses resist strongly.
            [/case]
        [/switch]

        # Apply adjacency bonus and clamp chances.
        {VARIABLE_OP necro_chance add $necro_bonus}
        [if]
            [variable]
                name=necro_chance
                less_than=10
            [/variable]
            [then]
                {VARIABLE necro_chance 10}  # Minimum 10% chance.
            [/then]
        [/if]
        [if]
            [variable]
                name=necro_chance
                greater_than=90
            [/variable]
            [then]
                {VARIABLE necro_chance 90}  # Maximum 90% chance.
            [/then]
        [/if]

        # Determine undead type based on race and level.
        [switch]
            variable=dead_unit.race
            [case]
                value=troll
                {VARIABLE target_type "Ghost"}
            [/case]
            [case]
                value=wose
                {VARIABLE target_type "Wraith"}
            [/case]
            [case]
                value=naga
                {VARIABLE target_type "Soulless"}
            [/case]
            [case]
                value=ogre
                {VARIABLE target_type "Ghoul"}
            [/case]
            [case]
                value=elf
                [if]
                    [variable]
                        name=dead_unit.level
                        greater_than_equal_to=2
                    [/variable]
                    [then]
                        {VARIABLE target_type "Wraith"}
                    [/then]
                    [else]
                        {VARIABLE target_type "Ghost"}
                    [/else]
                [/if]
            [/case]
            [else]
                # Default undead types for humanoids.
                [if]
                    [variable]
                        name=dead_unit.level
                        greater_than_equal_to=2
                    [/variable]
                    [then]
                        [switch]
                            variable=dead_unit.usage
                            [case]
                                value=fighter
                                {VARIABLE target_type "Revenant"}
                            [/case]
                            [case]
                                value=archer
                                {VARIABLE target_type "Bone Shooter"}
                            [/case]
                            [case]
                                value=mixed fighter
                                {VARIABLE target_type "Deathblade"}
                            [/case]
                            [else]
                                {VARIABLE target_type "Wraith"}
                            [/else]
                        [/switch]
                    [/then]
                    [elseif]
                        [variable]
                            name=dead_unit.level
                            equals=1
                        [/variable]
                        [then]
                            [switch]
                                variable=dead_unit.usage
                                [case]
                                    value=fighter
                                    {VARIABLE target_type "Skeleton"}
                                [/case]
                                [case]
                                    value=archer
                                    {VARIABLE target_type "Skeleton Archer"}
                                [/case]
                                [else]
                                    {VARIABLE target_type "Soulless"}
                                [/else]
                            [/switch]
                        [/then]
                    [/elseif]
                    [else]
                        {VARIABLE target_type "Walking Corpse"}
                    [/else]
                [/if]
            [/else]
        [/switch]

        # Get unit type information to determine mana cost.
        [store_unit_type]
            type=$target_type
            variable=target_unit_type
        [/store_unit_type]

        # Set mana cost based on unit level.
        [switch]
            variable=target_unit_type.level
            [case]
                value=0
                {VARIABLE mana_cost $mana_cost_level_0}
            [/case]
            [case]
                value=1
                {VARIABLE mana_cost $mana_cost_level_1}
            [/case]
            [case]
                value=2
                {VARIABLE mana_cost $mana_cost_level_2}
            [/case]
            [case]
                value=3
                {VARIABLE mana_cost $mana_cost_level_3}
            [/case]
            [else]
                {VARIABLE mana_cost 40}
            [/else]
        [/switch]

        # Roll for necromancy success.
        {RANDOM 1..100}
        [if]
            [variable]
                name=random
                less_than_equal_to=$necro_chance
            [/variable]
            [and]
                [variable]
                    name=gwiti_mana
                    greater_than_equal_to=$mana_cost
                [/variable]
            [/and]
            [and]
                [variable]
                    name=current_called_units
                    less_than=$max_called_units
                [/variable]
            [/and]
            [then]
                # Successful necromancy animation.
                [animate_unit]
                    [filter]
                        id="Gwiti Ha'atel"
                    [/filter]
                    flag=recruit
                    [facing]
                        x,y=$dead_unit.x,$dead_unit.y
                    [/facing]
                [/animate_unit]

                # Create the new undead unit.
                [unit]
                    type=$target_type
                    side=1
                    x,y=$dead_unit.x,$dead_unit.y
                    facing=$dead_unit.facing
                    gender=$dead_unit.gender
                    variation=$dead_unit.undead_variation
                    animate=yes
                    attacks_left=0
                    moves=0
                    resting=no
                    [modifications]
                        {OBJ_DUMMY_LOYAL}
                    [/modifications]
                    [variables]
                        called=yes
                    [/variables]
                [/unit]
                [redraw]
                    clear_shroud=yes
                [/redraw]

                # Update mana and counters.
                {VARIABLE_OP gwiti_mana sub $mana_cost}
                {VARIABLE_OP current_called_units add 1}
                {VARIABLE_OP total_necro_actions add 1}
                {DISPLAY_STATUS}

                # Show success messages.
                [floating_text]
                    x,y=$dead_unit.x,$dead_unit.y
                    text="<span color='#00FF00' size='x-small'>$target_type</span>"
                [/floating_text]
                [switch]
                    variable=target_type
                    [case]
                        value=Ghost
                        [message]
                            speaker="Gwiti Ha'atel"
                            message= _ "A spirit rises to serve!"
                        [/message]
                    [/case]
                    [case]
                        value=Wraith
                        [message]
                            speaker="Gwiti Ha'atel"
                            message= _ "A wraith answers my call!"
                        [/message]
                    [/case]
                [/switch]
            [/then]
            [else]
                # Failed necromancy - show reasons.
                [if]
                    [variable]
                        name=gwiti_mana
                        less_than=$mana_cost
                    [/variable]
                    [then]
                        # Not enough mana.
                        [floating_text]
                            x,y=$dead_unit.x,$dead_unit.y
                            text= _ "<span color='#FF0000' size='x-small'>Need $mana_cost mana to call $target_type!</span>"
                        [/floating_text]
                    [/then]
                    [elseif]
                        [variable]
                            name=current_called_units
                            greater_than_equal_to=$max_called_units
                        [/variable]
                        [then]
                            # Too many units already called.
                            [floating_text]
                                x,y=$dead_unit.x,$dead_unit.y
                                text= _ "<span color='#FF0000' size='x-small'>Cannot call more units!</span> <span color='#FFFFFF' size='x-small'>(Limit: $max_called_units)</span>"
                            [/floating_text]
                        [/then]
                    [/elseif]
                    [else]
                        # Failed roll check.
                        [floating_text]
                            x,y=$dead_unit.x,$dead_unit.y
                            text= _ "<span color='#FF0000' size='x-small'>The soul resists the call!</span>"
                        [/floating_text]
                    [/else]
                [/if]
            [/else]
        [/if]

        # Clean up variables.
        {CLEAR_VARIABLE dead_unit,necro_chance,random,target_type,mana_cost,necro_bonus,target_unit_type}
    [/event]

    # Update status display when Gwiti is selected.
    [event]
        name=select
        first_time_only=no
        [filter]
            id="Gwiti Ha'atel"
        [/filter]
        {DISPLAY_STATUS}
    [/event]

    # Clean up all variables at scenario end.
    [event]
        name=victory
        {CLEAR_VARIABLE necromancy_used,gwiti_mana,gwiti_max_mana,gwiti_mana_regen,current_called_units,max_called_units,total_necro_actions,necro_tier}
    [/event]
#enddef
